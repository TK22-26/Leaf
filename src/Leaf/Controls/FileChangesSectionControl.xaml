<UserControl
    x:Class="Leaf.Controls.FileChangesSectionControl"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="clr-namespace:Leaf.Controls"
    xmlns:converters="clr-namespace:Leaf.Converters"
    xmlns:models="clr-namespace:Leaf.Models"
    xmlns:utils="clr-namespace:Leaf.Utils"
    x:Name="Root">

    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Views/Resources/FileStatusResources.xaml" />
            </ResourceDictionary.MergedDictionaries>

            <!--  Binding proxy to allow ContextMenu access to Root's Context property  -->
            <utils:BindingProxy x:Key="ContextProxy" Data="{Binding Context, Source={x:Reference Root}}" />

            <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
            <converters:BoolToGridLengthConverter x:Key="BoolToGridLengthConverter" />
            <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter" />
            <converters:ReservedFileNameToVisibilityConverter x:Key="ReservedFileNameToVisibilityConverter" />

            <!--  Tree node template  -->
            <HierarchicalDataTemplate
                x:Key="TreeNodeTemplate"
                DataType="{x:Type models:PathTreeNode}"
                ItemsSource="{Binding Children}">
                <Grid>
                    <!--  Folder display  -->
                    <StackPanel
                        Margin="2,1"
                        Orientation="Horizontal"
                        Visibility="{Binding IsFile, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse}">
                        <TextBlock
                            Margin="0,0,6,0"
                            FontFamily="Segoe Fluent Icons"
                            FontSize="14"
                            Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                            Text="&#xE8B7;" />
                        <TextBlock
                            FontSize="12"
                            Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                            Text="{Binding Name}" />
                    </StackPanel>

                    <!--  File display  -->
                    <Border
                        Margin="2,1"
                        Padding="8,6"
                        Background="Transparent"
                        BorderBrush="Transparent"
                        BorderThickness="2,0,0,0"
                        Cursor="Hand"
                        DataContext="{Binding File}"
                        ToolTip="{Binding Path}"
                        Visibility="{Binding DataContext.IsFile, RelativeSource={RelativeSource AncestorType=Grid}, Converter={StaticResource BoolToVisibilityConverter}}">
                        <Border.InputBindings>
                            <MouseBinding
                                Command="{Binding Context.FileSelectedCommand, ElementName=Root}"
                                CommandParameter="{Binding}"
                                MouseAction="LeftClick" />
                        </Border.InputBindings>
                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="Margin" Value="2,1" />
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="{DynamicResource LeafAccentHoverBrush}" />
                                        <Setter Property="BorderBrush" Value="#28A745" />
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                        <Border.ContextMenu>
                            <ContextMenu DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
                                <MenuItem
                                    Command="{Binding Data.PrimaryActionCommand, Source={StaticResource ContextProxy}}"
                                    CommandParameter="{Binding}"
                                    Header="{Binding Data.PrimaryActionText, Source={StaticResource ContextProxy}}" />
                                <MenuItem
                                    Command="{Binding Data.DiscardFileCommand, Source={StaticResource ContextProxy}}"
                                    CommandParameter="{Binding}"
                                    Header="Discard changes" />
                                <MenuItem Header="Ignore">
                                    <MenuItem Command="{Binding Data.IgnoreFileCommand, Source={StaticResource ContextProxy}}" CommandParameter="{Binding}">
                                        <MenuItem.Header>
                                            <TextBlock>
                                                <Run Text="Ignore '" /><Run Text="{Binding FileName, Mode=OneWay}" /><Run Text="'" />
                                            </TextBlock>
                                        </MenuItem.Header>
                                    </MenuItem>
                                    <MenuItem Command="{Binding Data.IgnoreExtensionCommand, Source={StaticResource ContextProxy}}" CommandParameter="{Binding}">
                                        <MenuItem.Header>
                                            <TextBlock>
                                                <Run Text="All files with extension '" /><Run Text="{Binding Extension, Mode=OneWay}" /><Run Text="'" />
                                            </TextBlock>
                                        </MenuItem.Header>
                                    </MenuItem>
                                    <MenuItem
                                        Command="{Binding Data.IgnoreDirectoryCommand, Source={StaticResource ContextProxy}}"
                                        CommandParameter="{Binding}"
                                        Visibility="{Binding Directory, Converter={StaticResource NullToVisibilityConverter}}">
                                        <MenuItem.Header>
                                            <TextBlock>
                                                <Run Text="All files in '" /><Run Text="{Binding Directory, Mode=OneWay}" /><Run Text="/'" />
                                            </TextBlock>
                                        </MenuItem.Header>
                                    </MenuItem>
                                </MenuItem>
                                <MenuItem
                                    Command="{Binding Data.StashFileCommand, Source={StaticResource ContextProxy}}"
                                    CommandParameter="{Binding}"
                                    Header="Stash file" />
                                <Separator />
                                <MenuItem
                                    Command="{Binding Data.OpenFileCommand, Source={StaticResource ContextProxy}}"
                                    CommandParameter="{Binding}"
                                    Header="Open file" />
                                <MenuItem
                                    Command="{Binding Data.OpenInExplorerCommand, Source={StaticResource ContextProxy}}"
                                    CommandParameter="{Binding}"
                                    Header="Open in Explorer" />
                                <MenuItem
                                    Command="{Binding Data.CopyFilePathCommand, Source={StaticResource ContextProxy}}"
                                    CommandParameter="{Binding}"
                                    Header="Copy file path" />
                                <Separator />
                                <MenuItem
                                    Command="{Binding Data.DeleteFileCommand, Source={StaticResource ContextProxy}}"
                                    CommandParameter="{Binding}"
                                    Foreground="#E81123"
                                    Header="Delete file" />
                            </ContextMenu>
                        </Border.ContextMenu>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="20" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <TextBlock
                                Grid.Column="0"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                FontSize="13"
                                Style="{StaticResource FileStatusIconStyle}"
                                Text="{Binding StatusIcon}" />
                            <TextBlock
                                Grid.Column="1"
                                VerticalAlignment="Center"
                                FontSize="12"
                                Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                                Text="{Binding FileName}"
                                TextTrimming="CharacterEllipsis" />
                        </Grid>
                    </Border>
                </Grid>
            </HierarchicalDataTemplate>
        </ResourceDictionary>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="{Binding IsExpanded, ElementName=Root, Converter={StaticResource BoolToGridLengthConverter}}" />
        </Grid.RowDefinitions>

        <!--  Section Header  -->
        <Grid Grid.Row="0" Margin="0,4,0,6">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="1" />
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <!--  Title with chevron and count  -->
            <StackPanel VerticalAlignment="Center" Orientation="Horizontal">
                <ToggleButton
                    Margin="0,0,6,0"
                    VerticalAlignment="Center"
                    IsChecked="{Binding IsExpanded, ElementName=Root, Mode=TwoWay}"
                    Style="{StaticResource SectionChevronToggleStyle}" />
                <TextBlock
                    VerticalAlignment="Center"
                    FontSize="12"
                    FontWeight="SemiBold"
                    Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                    Text="{Binding Context.SectionTitle, ElementName=Root}" />
                <TextBlock
                    Margin="6,0,0,0"
                    VerticalAlignment="Center"
                    FontSize="12"
                    Foreground="{DynamicResource TextFillColorTertiaryBrush}">
                    <Run Text="(" />
                    <Run Text="{Binding ItemCount, ElementName=Root, Mode=OneWay, FallbackValue=0}" />
                    <Run Text=")" />
                </TextBlock>
            </StackPanel>

            <!--  Toggle and action buttons  -->
            <StackPanel
                Grid.Column="1"
                Margin="0,0,0,3"
                VerticalAlignment="Center"
                Orientation="Horizontal">
                <controls:PillToggle
                    Width="84"
                    Height="22"
                    Margin="0,0,8,0"
                    VerticalAlignment="Center"
                    Checked="OnTreeToggleChanged"
                    IsChecked="{Binding ShowTreeView, ElementName=Root, Mode=TwoWay}"
                    LabelFontSize="12"
                    LeftText="List"
                    RightText="Tree"
                    ToolTip="Toggle list/tree view"
                    Unchecked="OnTreeToggleChanged" />

                <Button
                    Height="22"
                    MinWidth="88"
                    Padding="8,2"
                    VerticalAlignment="Center"
                    Command="{Binding Context.BulkActionCommand, ElementName=Root}"
                    Content="{Binding Context.BulkActionText, ElementName=Root}"
                    FontSize="11" />
            </StackPanel>

            <!--  Separator line  -->
            <Border
                Grid.Row="1"
                Grid.ColumnSpan="2"
                Height="1"
                Background="{DynamicResource ControlStrokeColorDefaultBrush}" />
        </Grid>

        <!--  File List/Tree Content  -->
        <Grid
            Grid.Row="1"
            Margin="0,0,0,8"
            Background="Transparent"
            Visibility="{Binding IsExpanded, ElementName=Root, Converter={StaticResource BoolToVisibilityConverter}}">
            <!--  List View  -->
            <ScrollViewer
                x:Name="ListScrollViewer"
                Padding="4"
                HorizontalScrollBarVisibility="Disabled"
                VerticalScrollBarVisibility="Auto">
                <ItemsControl ItemsSource="{Binding Context.FilesSource, ElementName=Root}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border
                                x:Name="ItemBorder"
                                Margin="2,1"
                                Padding="8,6"
                                Background="Transparent"
                                BorderBrush="Transparent"
                                BorderThickness="2,0,0,0"
                                CornerRadius="4"
                                Cursor="Hand"
                                ToolTip="{Binding Path}">
                                <Border.InputBindings>
                                    <MouseBinding
                                        Command="{Binding Context.FileSelectedCommand, ElementName=Root}"
                                        CommandParameter="{Binding}"
                                        MouseAction="LeftClick" />
                                </Border.InputBindings>
                                <Border.ContextMenu>
                                    <ContextMenu DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
                                        <MenuItem
                                            Command="{Binding Data.PrimaryActionCommand, Source={StaticResource ContextProxy}}"
                                            CommandParameter="{Binding}"
                                            Header="{Binding Data.PrimaryActionText, Source={StaticResource ContextProxy}}" />
                                        <MenuItem
                                            Command="{Binding Data.DiscardFileCommand, Source={StaticResource ContextProxy}}"
                                            CommandParameter="{Binding}"
                                            Header="Discard changes" />
                                        <MenuItem Header="Ignore">
                                            <MenuItem Command="{Binding Data.IgnoreFileCommand, Source={StaticResource ContextProxy}}" CommandParameter="{Binding}">
                                                <MenuItem.Header>
                                                    <TextBlock>
                                                        <Run Text="Ignore '" /><Run Text="{Binding FileName, Mode=OneWay}" /><Run Text="'" />
                                                    </TextBlock>
                                                </MenuItem.Header>
                                            </MenuItem>
                                            <MenuItem Command="{Binding Data.IgnoreExtensionCommand, Source={StaticResource ContextProxy}}" CommandParameter="{Binding}">
                                                <MenuItem.Header>
                                                    <TextBlock>
                                                        <Run Text="All files with extension '" /><Run Text="{Binding Extension, Mode=OneWay}" /><Run Text="'" />
                                                    </TextBlock>
                                                </MenuItem.Header>
                                            </MenuItem>
                                            <MenuItem
                                                Command="{Binding Data.IgnoreDirectoryCommand, Source={StaticResource ContextProxy}}"
                                                CommandParameter="{Binding}"
                                                Visibility="{Binding Directory, Converter={StaticResource NullToVisibilityConverter}}">
                                                <MenuItem.Header>
                                                    <TextBlock>
                                                        <Run Text="All files in '" /><Run Text="{Binding Directory, Mode=OneWay}" /><Run Text="/'" />
                                                    </TextBlock>
                                                </MenuItem.Header>
                                            </MenuItem>
                                        </MenuItem>
                                        <MenuItem
                                            Command="{Binding Data.StashFileCommand, Source={StaticResource ContextProxy}}"
                                            CommandParameter="{Binding}"
                                            Header="Stash file" />
                                        <Separator />
                                        <MenuItem
                                            Command="{Binding Data.OpenFileCommand, Source={StaticResource ContextProxy}}"
                                            CommandParameter="{Binding}"
                                            Header="Open file" />
                                        <MenuItem
                                            Command="{Binding Data.OpenInExplorerCommand, Source={StaticResource ContextProxy}}"
                                            CommandParameter="{Binding}"
                                            Header="Open in Explorer" />
                                        <MenuItem
                                            Command="{Binding Data.CopyFilePathCommand, Source={StaticResource ContextProxy}}"
                                            CommandParameter="{Binding}"
                                            Header="Copy file path" />
                                        <Separator />
                                        <MenuItem
                                            Command="{Binding Data.DeleteFileCommand, Source={StaticResource ContextProxy}}"
                                            CommandParameter="{Binding}"
                                            Foreground="#E81123"
                                            Header="Delete file" />
                                        <!--  Admin delete for reserved filenames (unstaged only)  -->
                                        <Separator Visibility="{Binding FileName, Converter={StaticResource ReservedFileNameToVisibilityConverter}}" />
                                        <MenuItem
                                            Command="{Binding Data.AdminDeleteCommand, Source={StaticResource ContextProxy}}"
                                            CommandParameter="{Binding}"
                                            FontWeight="SemiBold"
                                            Foreground="#E81123"
                                            Header="Admin Delete (Reserved Name)"
                                            Visibility="{Binding FileName, Converter={StaticResource ReservedFileNameToVisibilityConverter}}" />
                                    </ContextMenu>
                                </Border.ContextMenu>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="20" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>

                                    <!--  Status icon  -->
                                    <TextBlock
                                        Grid.RowSpan="2"
                                        Grid.Column="0"
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"
                                        FontSize="13"
                                        Style="{StaticResource FileStatusIconStyle}"
                                        Text="{Binding StatusIcon}" />

                                    <!--  File name  -->
                                    <TextBlock
                                        Grid.Row="0"
                                        Grid.Column="1"
                                        VerticalAlignment="Center"
                                        FontSize="13"
                                        Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                                        Text="{Binding FileName}"
                                        TextTrimming="CharacterEllipsis" />

                                    <!--  Directory path  -->
                                    <TextBlock
                                        Grid.Row="1"
                                        Grid.Column="1"
                                        FontSize="10"
                                        Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                                        Text="{Binding Directory}"
                                        TextTrimming="CharacterEllipsis">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Visibility" Value="Visible" />
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Directory}" Value="">
                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>

                                    <!--  Primary action button  -->
                                    <Button
                                        x:Name="ActionButton"
                                        Grid.RowSpan="2"
                                        Grid.Column="2"
                                        Padding="8,2"
                                        VerticalAlignment="Center"
                                        Command="{Binding Context.PrimaryActionCommand, ElementName=Root}"
                                        CommandParameter="{Binding}"
                                        Content="{Binding Context.PrimaryActionText, ElementName=Root}"
                                        FontSize="10"
                                        Visibility="Hidden" />
                                </Grid>
                            </Border>
                            <DataTemplate.Triggers>
                                <Trigger SourceName="ItemBorder" Property="IsMouseOver" Value="True">
                                    <Setter TargetName="ItemBorder" Property="Background" Value="{DynamicResource LeafAccentHoverBrush}" />
                                    <Setter TargetName="ItemBorder" Property="BorderBrush" Value="#28A745" />
                                    <Setter TargetName="ActionButton" Property="Visibility" Value="Visible" />
                                </Trigger>
                            </DataTemplate.Triggers>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>

            <!--  Tree View  -->
            <TreeView
                x:Name="FileTreeView"
                Padding="4"
                Background="Transparent"
                BorderThickness="0"
                ItemTemplate="{StaticResource TreeNodeTemplate}"
                ItemsSource="{Binding Context.TreeItemsSource, ElementName=Root}"
                VirtualizingStackPanel.IsVirtualizing="True"
                VirtualizingStackPanel.VirtualizationMode="Recycling">
                <TreeView.ItemContainerStyle>
                    <Style BasedOn="{StaticResource {x:Type TreeViewItem}}" TargetType="TreeViewItem">
                        <Style.Triggers>
                            <MultiDataTrigger>
                                <MultiDataTrigger.Conditions>
                                    <Condition Binding="{Binding RelativeSource={RelativeSource Self}, Path=HasItems}" Value="False" />
                                    <Condition Binding="{Binding IsRoot}" Value="True" />
                                </MultiDataTrigger.Conditions>
                                <Setter Property="Margin" Value="-19,0,0,0" />
                                <Setter Property="Padding" Value="0,2" />
                            </MultiDataTrigger>
                        </Style.Triggers>
                    </Style>
                </TreeView.ItemContainerStyle>
            </TreeView>
        </Grid>
    </Grid>
</UserControl>
