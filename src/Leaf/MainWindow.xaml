<Window
    x:Class="Leaf.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:behaviors="clr-namespace:Leaf.Behaviors"
    xmlns:controls="clr-namespace:Leaf.Controls"
    xmlns:converters="clr-namespace:Leaf.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:ic="clr-namespace:FluentIcons.Wpf;assembly=FluentIcons.Wpf"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:views="clr-namespace:Leaf.Views"
    Title="Leaf - Git Repository Manager"
    Width="1200"
    Height="700"
    MinWidth="900"
    MinHeight="500"
    behaviors:HorizontalScrollBehavior.EnableHorizontalScroll="True"
    Icon="{StaticResource AppIcon}"
    WindowStartupLocation="CenterScreen"
    mc:Ignorable="d">

    <Window.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter" />
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter" />
        <converters:InverseBoolConverter x:Key="InverseBoolConverter" />
        <converters:IntGreaterThanZeroConverter x:Key="IntGreaterThanZeroConverter" />
        <converters:TerminalRowHeightConverter x:Key="TerminalRowHeightConverter" />

        <!--  Action bar button style with green hover (stacked icon + text)  -->
        <Style
            x:Key="ActionBarButtonStyle"
            BasedOn="{StaticResource {x:Type Button}}"
            TargetType="Button">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Margin" Value="1,0" />
            <Setter Property="Padding" Value="8,4" />
            <Setter Property="MinWidth" Value="46" />
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{DynamicResource LeafAccentHoverBrush}" />
                </Trigger>
            </Style.Triggers>
        </Style>
    </Window.Resources>

    <Window.InputBindings>
        <KeyBinding
            Key="Oem3"
            Command="{Binding ToggleTerminalCommand}"
            Modifiers="Control" />
        <KeyBinding Key="F1" Command="{Binding ReportIssueCommand}" />
    </Window.InputBindings>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!--  Menu  -->
        <Border
            Grid.Row="0"
            BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
            BorderThickness="0,0,0,1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <Menu Grid.Column="0">
                    <MenuItem Header="_File">
                        <MenuItem Command="{Binding AddRepositoryCommand}" Header="_Add Repository..." />
                        <MenuItem Command="{Binding AddAllReposInFolderCommand}" Header="Add All Repos in _Folder..." />
                        <Separator />
                        <MenuItem Command="{Binding OpenSettingsCommand}" Header="_Settings" />
                    </MenuItem>
                    <MenuItem Header="_Repository">
                        <MenuItem Command="{Binding CloneRepositoryCommand}" Header="_Clone..." />
                        <Separator />
                        <MenuItem Command="{Binding FetchAllCommand}" Header="_Fetch All" />
                        <MenuItem Command="{Binding RefreshCommand}" Header="_Refresh" />
                        <Separator />
                        <MenuItem Header="_GitFlow">
                            <MenuItem.Icon>
                                <ic:SymbolIcon FontSize="14" Symbol="BranchFork" />
                            </MenuItem.Icon>
                            <MenuItem Command="{Binding InitializeGitFlowCommand}" Header="Initialize GitFlow...">
                                <MenuItem.Icon>
                                    <ic:SymbolIcon FontSize="14" Symbol="Settings" />
                                </MenuItem.Icon>
                            </MenuItem>
                            <Separator />
                            <MenuItem Command="{Binding StartFeatureCommand}" Header="Start Feature...">
                                <MenuItem.Icon>
                                    <Border
                                        Width="14"
                                        Height="14"
                                        Background="#8250DF"
                                        CornerRadius="7" />
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Command="{Binding StartReleaseCommand}" Header="Start Release...">
                                <MenuItem.Icon>
                                    <Border
                                        Width="14"
                                        Height="14"
                                        Background="#BF8700"
                                        CornerRadius="7" />
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Command="{Binding StartHotfixCommand}" Header="Start Hotfix...">
                                <MenuItem.Icon>
                                    <Border
                                        Width="14"
                                        Height="14"
                                        Background="#CF222E"
                                        CornerRadius="7" />
                                </MenuItem.Icon>
                            </MenuItem>
                        </MenuItem>
                    </MenuItem>
                    <MenuItem Header="_View">
                        <MenuItem
                            Header="Terminal"
                            InputGestureText="Ctrl+`"
                            IsCheckable="True"
                            IsChecked="{Binding IsTerminalVisible, Mode=TwoWay}" />
                    </MenuItem>
                    <MenuItem Header="_Help">
                        <MenuItem Command="{Binding CheckForUpdatesCommand}" Header="Check for _Updates...">
                            <MenuItem.Icon>
                                <ic:SymbolIcon FontSize="14" Symbol="ArrowDownload" />
                            </MenuItem.Icon>
                        </MenuItem>
                        <MenuItem Command="{Binding OpenReleasesPageCommand}" Header="View _Releases">
                            <MenuItem.Icon>
                                <ic:SymbolIcon FontSize="14" Symbol="Open" />
                            </MenuItem.Icon>
                        </MenuItem>
                        <Separator />
                        <MenuItem
                            Command="{Binding ReportIssueCommand}"
                            Header="_Report an Issue..."
                            InputGestureText="F1">
                            <MenuItem.Icon>
                                <ic:SymbolIcon FontSize="14" Symbol="Bug" />
                            </MenuItem.Icon>
                        </MenuItem>
                    </MenuItem>
                </Menu>

                <!--  Update Available Indicator  -->
                <Button
                    Grid.Column="1"
                    Margin="0,0,8,3"
                    Padding="8,3"
                    VerticalAlignment="Bottom"
                    Background="#2D6A3E"
                    BorderThickness="0"
                    Command="{Binding CheckForUpdatesCommand}"
                    Cursor="Hand"
                    Visibility="{Binding IsUpdateAvailable, Converter={StaticResource BoolToVisibilityConverter}}">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock
                            VerticalAlignment="Center"
                            FontFamily="Segoe UI Emoji"
                            FontSize="12"
                            Text="ðŸŽ‰" />
                        <TextBlock
                            Margin="6,0,0,0"
                            VerticalAlignment="Center"
                            FontSize="11"
                            FontWeight="SemiBold"
                            Foreground="#C0E8CC"
                            Text="Update Available" />
                    </StackPanel>
                </Button>
            </Grid>
        </Border>

        <!--  Repository Action Bar  -->
        <Border
            Grid.Row="1"
            Padding="12,6"
            Background="{DynamicResource ControlFillColorDefaultBrush}"
            BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
            BorderThickness="0,0,0,1"
            Visibility="{Binding SelectedRepository, Converter={StaticResource NullToVisibilityConverter}}">
            <!--  Three-column Grid: equal left/right columns keep center truly centered  -->
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <!--  Left: Repository and Branch info (star columns shrink and trim text)  -->
                <Grid
                    Grid.Column="0"
                    VerticalAlignment="Center">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!--  Repository  -->
                    <StackPanel Grid.Column="0" Margin="0,0,16,0">
                        <TextBlock
                            FontSize="10"
                            Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                            Text="Repository"
                            TextTrimming="CharacterEllipsis" />
                        <TextBlock
                            FontWeight="SemiBold"
                            Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                            Text="{Binding SelectedRepository.Name}"
                            TextTrimming="CharacterEllipsis"
                            ToolTip="{Binding SelectedRepository.Name}" />
                    </StackPanel>

                    <!--  Chevron separator  -->
                    <TextBlock
                        Grid.Column="1"
                        Margin="0,0,16,0"
                        VerticalAlignment="Center"
                        FontFamily="Segoe Fluent Icons"
                        FontSize="10"
                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                        Text="&#xE76C;" />

                    <!--  Branch  -->
                    <StackPanel Grid.Column="2">
                        <TextBlock
                            FontSize="10"
                            Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                            Text="Branch"
                            TextTrimming="CharacterEllipsis" />
                        <TextBlock
                            FontWeight="SemiBold"
                            Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                            Text="{Binding SelectedRepository.CurrentBranch, FallbackValue='(none)'}"
                            TextTrimming="CharacterEllipsis"
                            ToolTip="{Binding SelectedRepository.CurrentBranch}" />
                    </StackPanel>
                </Grid>

                <!--  Center: Quick Actions (in center column, always centered)  -->
                <StackPanel
                    Grid.Column="1"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Orientation="Horizontal">
                    <!--  Undo  -->
                    <Button
                        Command="{Binding UndoCommand}"
                        Style="{StaticResource ActionBarButtonStyle}"
                        ToolTip="Undo last commit (before push)">
                        <StackPanel HorizontalAlignment="Center">
                            <TextBlock
                                HorizontalAlignment="Center"
                                FontFamily="Segoe Fluent Icons"
                                FontSize="16"
                                Text="&#xE7A7;" />
                            <TextBlock
                                HorizontalAlignment="Center"
                                FontSize="10"
                                Text="Undo" />
                        </StackPanel>
                    </Button>
                    <!--  Redo  -->
                    <Button
                        Command="{Binding RedoCommand}"
                        Style="{StaticResource ActionBarButtonStyle}"
                        ToolTip="Redo last undone commit">
                        <StackPanel HorizontalAlignment="Center">
                            <TextBlock
                                HorizontalAlignment="Center"
                                FontFamily="Segoe Fluent Icons"
                                FontSize="16"
                                Text="&#xE7A6;" />
                            <TextBlock
                                HorizontalAlignment="Center"
                                FontSize="10"
                                Text="Redo" />
                        </StackPanel>
                    </Button>
                    <Rectangle
                        Width="1"
                        Height="28"
                        Margin="8,0"
                        VerticalAlignment="Center"
                        Fill="{DynamicResource TextFillColorSecondaryBrush}" />
                    <!--  Pull  -->
                    <Button
                        Command="{Binding PullCommand}"
                        Style="{StaticResource ActionBarButtonStyle}"
                        ToolTip="Pull changes from remote">
                        <StackPanel HorizontalAlignment="Center">
                            <TextBlock
                                HorizontalAlignment="Center"
                                FontFamily="Segoe Fluent Icons"
                                FontSize="16"
                                Text="&#xE74B;" />
                            <TextBlock
                                HorizontalAlignment="Center"
                                FontSize="10"
                                Text="Pull" />
                        </StackPanel>
                    </Button>
                    <!--  Push  -->
                    <Button
                        Command="{Binding PushCommand}"
                        Style="{StaticResource ActionBarButtonStyle}"
                        ToolTip="Push changes to remote">
                        <StackPanel HorizontalAlignment="Center">
                            <TextBlock
                                HorizontalAlignment="Center"
                                FontFamily="Segoe Fluent Icons"
                                FontSize="16"
                                Text="&#xE74A;" />
                            <TextBlock
                                HorizontalAlignment="Center"
                                FontSize="10"
                                Text="Push" />
                        </StackPanel>
                    </Button>
                    <Rectangle
                        Width="1"
                        Height="28"
                        Margin="8,0"
                        VerticalAlignment="Center"
                        Fill="{DynamicResource TextFillColorSecondaryBrush}" />
                    <!--  Branch  -->
                    <Button
                        Command="{Binding CreateBranchCommand}"
                        Style="{StaticResource ActionBarButtonStyle}"
                        ToolTip="Create new branch">
                        <StackPanel HorizontalAlignment="Center">
                            <ic:SymbolIcon
                                HorizontalAlignment="Center"
                                FontSize="16"
                                Symbol="BranchFork" />
                            <TextBlock
                                HorizontalAlignment="Center"
                                FontSize="10"
                                Text="Branch" />
                        </StackPanel>
                    </Button>
                    <!--  GitFlow  -->
                    <Button
                        Command="{Binding InitializeGitFlowCommand}"
                        Style="{StaticResource ActionBarButtonStyle}"
                        ToolTip="GitFlow settings">
                        <StackPanel HorizontalAlignment="Center">
                            <ic:SymbolIcon
                                HorizontalAlignment="Center"
                                FontSize="16"
                                Symbol="Flow" />
                            <TextBlock
                                HorizontalAlignment="Center"
                                FontSize="10"
                                Text="GitFlow" />
                        </StackPanel>
                    </Button>
                    <Rectangle
                        Width="1"
                        Height="28"
                        Margin="8,0"
                        VerticalAlignment="Center"
                        Fill="{DynamicResource TextFillColorSecondaryBrush}" />
                    <!--  Stash  -->
                    <Button
                        Command="{Binding StashCommand}"
                        Style="{StaticResource ActionBarButtonStyle}"
                        ToolTip="Stash changes">
                        <StackPanel HorizontalAlignment="Center">
                            <TextBlock
                                HorizontalAlignment="Center"
                                FontFamily="Segoe Fluent Icons"
                                FontSize="16"
                                Text="&#xE7B8;" />
                            <TextBlock
                                HorizontalAlignment="Center"
                                FontSize="10"
                                Text="Stash" />
                        </StackPanel>
                    </Button>
                    <!--  Pop  -->
                    <Button Command="{Binding PopStashCommand}" ToolTip="Pop stashed changes (select a stash first)">
                        <Button.Style>
                            <Style BasedOn="{StaticResource ActionBarButtonStyle}" TargetType="Button">
                                <Setter Property="Opacity" Value="1" />
                                <Style.Triggers>
                                    <Trigger Property="IsEnabled" Value="False">
                                        <Setter Property="Opacity" Value="0.4" />
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                        <StackPanel HorizontalAlignment="Center">
                            <TextBlock
                                HorizontalAlignment="Center"
                                FontFamily="Segoe Fluent Icons"
                                FontSize="16"
                                Text="&#xE7B7;" />
                            <TextBlock
                                HorizontalAlignment="Center"
                                FontSize="10"
                                Text="Pop" />
                        </StackPanel>
                    </Button>
                </StackPanel>

                <!--  Right: Search (live search, no button needed)  -->
                <Grid Grid.Column="2" HorizontalAlignment="Right" VerticalAlignment="Center">
                    <TextBox
                        x:Name="CommitSearchBox"
                        Width="200"
                        VerticalContentAlignment="Center"
                        Text="{Binding CommitSearchText, UpdateSourceTrigger=PropertyChanged}" />
                    <TextBlock
                        Margin="12,0,0,0"
                        VerticalAlignment="Center"
                        Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                        IsHitTestVisible="False"
                        Text="Search commits...">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Visibility" Value="Collapsed" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Text, ElementName=CommitSearchBox}" Value="">
                                        <Setter Property="Visibility" Value="Visible" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                </Grid>
            </Grid>
        </Border>

        <!--  Global progress bar (overlays top of main content to avoid layout bounce)  -->
        <ProgressBar
            Grid.Row="2"
            Height="2"
            VerticalAlignment="Top"
            Panel.ZIndex="10"
            Background="Transparent"
            BorderBrush="Transparent"
            BorderThickness="0"
            Foreground="#28A745"
            IsIndeterminate="{Binding IsBusy}"
            Visibility="{Binding IsBusy, Converter={StaticResource BoolToVisibilityConverter}}">
            <ProgressBar.Style>
                <Style TargetType="ProgressBar">
                    <Setter Property="SnapsToDevicePixels" Value="True" />
                    <Setter Property="OverridesDefaultStyle" Value="True" />
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="ProgressBar">
                                <Grid x:Name="TemplateRoot" ClipToBounds="True">
                                    <Border Background="{TemplateBinding Background}" />
                                    <Rectangle x:Name="PART_Track" />
                                    <Grid
                                        x:Name="PART_Indicator"
                                        HorizontalAlignment="Left"
                                        Background="Transparent">
                                        <Rectangle x:Name="Indicator" Fill="{TemplateBinding Foreground}" />
                                    </Grid>
                                    <!--  Indeterminate sliding bar: independent of PART_Indicator to avoid layout interference  -->
                                    <Rectangle
                                        x:Name="Animation"
                                        Width="300"
                                        HorizontalAlignment="Left"
                                        CacheMode="BitmapCache"
                                        Fill="{TemplateBinding Foreground}"
                                        Visibility="Collapsed">
                                        <Rectangle.RenderTransform>
                                            <TranslateTransform />
                                        </Rectangle.RenderTransform>
                                    </Rectangle>
                                </Grid>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsIndeterminate" Value="True">
                                        <Setter TargetName="Indicator" Property="Visibility" Value="Collapsed" />
                                        <Setter TargetName="Animation" Property="Visibility" Value="Visible" />
                                        <Trigger.EnterActions>
                                            <BeginStoryboard>
                                                <Storyboard RepeatBehavior="Forever" Timeline.DesiredFrameRate="60">
                                                    <DoubleAnimation
                                                        Storyboard.TargetName="Animation"
                                                        Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.X)"
                                                        From="-300"
                                                        To="1600"
                                                        Duration="0:0:1.5" />
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </Trigger.EnterActions>
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </ProgressBar.Style>
        </ProgressBar>

        <!--  Main layout + terminal pane  -->
        <Grid Grid.Row="2">
            <Grid.RowDefinitions>
                <RowDefinition Height="*" />
                <RowDefinition x:Name="TerminalRow">
                    <RowDefinition.Height>
                        <MultiBinding Converter="{StaticResource TerminalRowHeightConverter}">
                            <Binding Path="DataContext.TerminalHeight" RelativeSource="{RelativeSource AncestorType=Window}" />
                            <Binding Path="DataContext.IsTerminalVisible" RelativeSource="{RelativeSource AncestorType=Window}" />
                        </MultiBinding>
                    </RowDefinition.Height>
                    <RowDefinition.Style>
                        <Style TargetType="RowDefinition">
                            <Setter Property="MinHeight" Value="120" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding DataContext.IsTerminalVisible, RelativeSource={RelativeSource AncestorType=Window}}" Value="False">
                                    <Setter Property="MinHeight" Value="0" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </RowDefinition.Style>
                </RowDefinition>
            </Grid.RowDefinitions>

            <!--  Main four-panel layout  -->
            <Grid Grid.Row="0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="250" MinWidth="200" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="350" MinWidth="0" />
                </Grid.ColumnDefinitions>

                <!--  Left panel: Repository list (collapsible + resizable)  -->
                <Border
                    Grid.Column="0"
                    BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                    BorderThickness="0,0,1,0">
                    <Grid>
                        <!--  Collapsed state: narrow clickable bar with chevron  -->
                        <Border
                            Width="16"
                            HorizontalAlignment="Left"
                            Background="{DynamicResource ControlFillColorDefaultBrush}"
                            Cursor="Hand"
                            MouseLeftButtonDown="RepoPane_MouseLeftButtonDown"
                            Visibility="{Binding IsRepoPaneCollapsed, Converter={StaticResource BoolToVisibilityConverter}}">
                            <Border.ToolTip>Click to expand repositories</Border.ToolTip>
                            <TextBlock
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                FontFamily="Segoe Fluent Icons"
                                FontSize="10"
                                Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                Text="&#xE76C;" />
                        </Border>
                        <!--  Expanded state: full repo list with collapse button  -->
                        <Grid
                            x:Name="RepoPaneGrid"
                            MinWidth="150"
                            MaxWidth="400"
                            Width="{Binding RepoPaneWidth, Mode=TwoWay}"
                            Visibility="{Binding IsRepoPaneCollapsed, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse}">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="*" />
                            </Grid.RowDefinitions>
                            <!--  Header with collapse button  -->
                            <Border
                                Grid.Row="0"
                                Padding="8,4"
                                BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                                BorderThickness="0,0,0,1">
                                <Grid>
                                    <TextBlock
                                        VerticalAlignment="Center"
                                        FontWeight="SemiBold"
                                        Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                                        Text="Repositories" />
                                    <StackPanel
                                        Margin="0,0,0,0"
                                        HorizontalAlignment="Right"
                                        VerticalAlignment="Center"
                                        Orientation="Horizontal">
                                        <Button
                                            Padding="4,2"
                                            Background="Transparent"
                                            BorderThickness="0"
                                            Command="{Binding CloneRepositoryCommand}"
                                            Cursor="Hand"
                                            ToolTip="Clone repository">
                                            <ic:SymbolIcon
                                                FontSize="12"
                                                Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                Symbol="ArrowDownload" />
                                        </Button>
                                        <Button
                                            Padding="4,2"
                                            Background="Transparent"
                                            BorderThickness="0"
                                            Command="{Binding AddRepositoryCommand}"
                                            Cursor="Hand"
                                            ToolTip="Add repository">
                                            <ic:SymbolIcon
                                                FontSize="12"
                                                Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                Symbol="Add" />
                                        </Button>
                                        <Button
                                            Padding="4,2"
                                            Background="Transparent"
                                            BorderThickness="0"
                                            Command="{Binding ToggleRepoPaneCommand}"
                                            Cursor="Hand"
                                            ToolTip="Collapse panel">
                                            <TextBlock
                                                FontFamily="Segoe Fluent Icons"
                                                FontSize="10"
                                                Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                Text="&#xE76B;" />
                                        </Button>
                                    </StackPanel>
                                </Grid>
                            </Border>
                            <views:RepositoryListView
                                Grid.Row="1"
                                DataContext="{Binding}" />
                        </Grid>
                    </Grid>
                </Border>

                <!--  Resize splitter for repo pane (outside the panel, to the right)  -->
                <GridSplitter
                    Grid.Column="1"
                    Width="4"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Stretch"
                    Panel.ZIndex="1"
                    Background="Transparent"
                    Cursor="SizeWE"
                    DragDelta="RepoPaneSplitter_DragDelta"
                    DragCompleted="RepoPaneSplitter_DragCompleted"
                    Focusable="False"
                    Visibility="{Binding IsRepoPaneCollapsed, Converter={StaticResource InverseBoolToVisibilityConverter}}" />

                <!--  Second panel: Branches for selected repo  -->
                <Border
                    Grid.Column="1"
                    BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                    BorderThickness="0,0,1,0">
                    <views:BranchListView DataContext="{Binding}" />
                </Border>

                <!--  Center panel: Git graph + commit list  -->
                <Grid Grid.Column="2">
                    <views:GitGraphView DataContext="{Binding GitGraphViewModel}" Visibility="{Binding DataContext.IsDiffViewerVisible, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource InverseBoolToVisibilityConverter}}" />

                </Grid>

                <!--  Right panel: Commit details / Working changes / Merge Status  -->
                <Border
                    Grid.Column="3"
                    BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                    BorderThickness="1,0,0,0"
                    Visibility="{Binding IsCommitDetailVisible, Converter={StaticResource BoolToVisibilityConverter}}">
                    <Grid>
                        <!--  Priority 1: Merge Status View  -->
                        <views:MergeStatusView DataContext="{Binding}">
                            <views:MergeStatusView.Style>
                                <Style TargetType="views:MergeStatusView">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                    <Style.Triggers>
                                        <MultiDataTrigger>
                                            <MultiDataTrigger.Conditions>
                                                <Condition Binding="{Binding SelectedRepository.IsMergeInProgress}" Value="True" />
                                                <Condition Binding="{Binding SelectedRepository.ConflictCount, Converter={StaticResource IntGreaterThanZeroConverter}}" Value="True" />
                                            </MultiDataTrigger.Conditions>
                                            <Setter Property="Visibility" Value="Visible" />
                                        </MultiDataTrigger>
                                        <MultiDataTrigger>
                                            <MultiDataTrigger.Conditions>
                                                <Condition Binding="{Binding SelectedRepository.IsMergeInProgress}" Value="True" />
                                                <Condition Binding="{Binding MergeConflictResolutionViewModel.TotalCount, Converter={StaticResource IntGreaterThanZeroConverter}}" Value="True" />
                                            </MultiDataTrigger.Conditions>
                                            <Setter Property="Visibility" Value="Visible" />
                                        </MultiDataTrigger>
                                        <!-- Show when conflicts exist (squash merge, etc.) even without MERGE_HEAD -->
                                        <DataTrigger Binding="{Binding SelectedRepository.ConflictCount, Converter={StaticResource IntGreaterThanZeroConverter}}" Value="True">
                                            <Setter Property="Visibility" Value="Visible" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </views:MergeStatusView.Style>
                        </views:MergeStatusView>

                        <!--  Priority 2: Working Changes View  -->
                        <views:WorkingChangesView DataContext="{Binding WorkingChangesViewModel}">
                            <views:WorkingChangesView.Style>
                                <Style TargetType="views:WorkingChangesView">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                    <Style.Triggers>
                                        <MultiDataTrigger>
                                            <MultiDataTrigger.Conditions>
                                                <!--  Show if WorkingChangesSelected AND NOT MergeInProgress AND no conflicts  -->
                                                <Condition Binding="{Binding DataContext.IsWorkingChangesSelected, RelativeSource={RelativeSource AncestorType=Window}}" Value="True" />
                                                <Condition Binding="{Binding DataContext.SelectedRepository.IsMergeInProgress, RelativeSource={RelativeSource AncestorType=Window}}" Value="False" />
                                                <Condition Binding="{Binding DataContext.SelectedRepository.ConflictCount, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource IntGreaterThanZeroConverter}}" Value="False" />
                                            </MultiDataTrigger.Conditions>
                                            <Setter Property="Visibility" Value="Visible" />
                                        </MultiDataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </views:WorkingChangesView.Style>
                        </views:WorkingChangesView>

                        <!--  Priority 3: Commit Detail View (Default)  -->
                        <views:CommitDetailView DataContext="{Binding CommitDetailViewModel}">
                            <views:CommitDetailView.Style>
                                <Style TargetType="views:CommitDetailView">
                                    <Setter Property="Visibility" Value="Visible" />
                                    <Style.Triggers>
                                        <!--  Hide if WorkingChangesSelected  -->
                                        <DataTrigger Binding="{Binding DataContext.IsWorkingChangesSelected, RelativeSource={RelativeSource AncestorType=Window}}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                        </DataTrigger>
                                        <!--  Hide if MergeInProgress  -->
                                        <DataTrigger Binding="{Binding DataContext.SelectedRepository.IsMergeInProgress, RelativeSource={RelativeSource AncestorType=Window}}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                        </DataTrigger>
                                        <!--  Hide if conflicts exist (e.g., squash merge conflicts)  -->
                                        <DataTrigger Binding="{Binding DataContext.SelectedRepository.ConflictCount, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource IntGreaterThanZeroConverter}}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </views:CommitDetailView.Style>
                        </views:CommitDetailView>
                    </Grid>
                </Border>

                <!--  Splitters (declared after content so they're on top for mouse events)  -->
                <GridSplitter
                    Grid.Column="2"
                    Width="4"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Stretch"
                    Background="Transparent"
                    Cursor="SizeWE"
                    Focusable="False"
                    ResizeBehavior="PreviousAndCurrent"
                    ResizeDirection="Columns" />
                <GridSplitter
                    Grid.Column="3"
                    Width="4"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Stretch"
                    Background="Transparent"
                    Cursor="SizeWE"
                    Focusable="False"
                    ResizeBehavior="PreviousAndCurrent"
                    ResizeDirection="Columns"
                    Visibility="{Binding IsCommitDetailVisible, Converter={StaticResource BoolToVisibilityConverter}}" />

                <!--  Diff Viewer Overlay (center panel only)  -->
                <controls:DiffViewerControl
                    Grid.Column="2"
                    DataContext="{Binding DiffViewerViewModel}"
                    Visibility="{Binding DataContext.IsDiffViewerVisible, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource BoolToVisibilityConverter}}" />
            </Grid>

            <!--  Terminal splitter  -->
            <GridSplitter
                x:Name="TerminalSplitter"
                Grid.Row="1"
                Height="4"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Top"
                Panel.ZIndex="2"
                Background="Transparent"
                Cursor="SizeNS"
                DragCompleted="TerminalSplitter_DragCompleted"
                Focusable="False"
                ResizeBehavior="PreviousAndCurrent"
                ResizeDirection="Rows"
                Visibility="{Binding DataContext.IsTerminalVisible, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource BoolToVisibilityConverter}}" />

            <!--  Terminal pane - wrapped in ContentControl to properly handle visibility  -->
            <ContentControl
                Grid.Row="1"
                Margin="0,4,0,0"
                Focusable="False">
                <ContentControl.Style>
                    <Style TargetType="ContentControl">
                        <Setter Property="Content">
                            <Setter.Value>
                                <views:TerminalView
                                    x:Name="TerminalPane"
                                    MinHeight="120"
                                    DataContext="{Binding TerminalViewModel}" />
                            </Setter.Value>
                        </Setter>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding DataContext.IsTerminalVisible, RelativeSource={RelativeSource AncestorType=Window}}" Value="False">
                                <Setter Property="Content" Value="{x:Null}" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </ContentControl.Style>
            </ContentControl>
        </Grid>
    </Grid>
</Window>
