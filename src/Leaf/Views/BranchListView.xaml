<UserControl x:Class="Leaf.Views.BranchListView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:converters="clr-namespace:Leaf.Converters"
             xmlns:models="clr-namespace:Leaf.Models"
             xmlns:ic="clr-namespace:FluentIcons.Wpf;assembly=FluentIcons.Wpf"
             mc:Ignorable="d"
             d:DesignHeight="450" d:DesignWidth="200">

    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <converters:NullToVisibilityInverseConverter x:Key="NullToVisibilityInverseConverter"/>
        <converters:BranchCategoryItemsConverter x:Key="BranchCategoryItemsConverter"/>
        <converters:InverseBoolConverter x:Key="InverseBoolConverter"/>
        <converters:BranchNameToGitFlowColorConverter x:Key="BranchNameToGitFlowColorConverter"/>
        <converters:BranchNameToGitFlowVisibilityConverter x:Key="BranchNameToGitFlowVisibilityConverter"/>
        <converters:GitFlowTypeToVisibilityConverter x:Key="GitFlowTypeToVisibilityConverter"/>

        <!-- Multi-select TreeViewItem style for BranchInfo items -->
        <!-- NOTE: Does NOT use TreeViewItem.IsSelected triggers to avoid single-selection enforcement -->
        <!-- Selection visuals are driven by DataTrigger on DataContext.IsSelected instead -->
        <Style x:Key="MultiSelectBranchTreeViewItemStyle" TargetType="{x:Type TreeViewItem}">
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            <Setter Property="Foreground" Value="{DynamicResource TreeViewItemForeground}"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Margin" Value="0"/>
            <Setter Property="Padding" Value="4,2"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="IsTabStop" Value="True"/>
            <Setter Property="OverridesDefaultStyle" Value="True"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type TreeViewItem}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <!-- Full-width highlight border -->
                            <Border x:Name="HighlightBorder"
                                    Grid.Row="0"
                                    CornerRadius="{DynamicResource ControlCornerRadius}"
                                    Margin="0,1">
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Setter Property="Background" Value="Transparent"/>
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Background" Value="{DynamicResource LeafAccentHoverBrush}"/>
                                            </Trigger>
                                            <!-- Use DataContext.IsSelected for multi-select visual -->
                                            <!-- FallbackValue=False prevents errors for BranchCategory/RemoteBranchGroup items -->
                                            <DataTrigger Binding="{Binding IsSelected, FallbackValue=False}" Value="True">
                                                <Setter Property="Background" Value="{DynamicResource LeafAccentSelectedBrush}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" MinWidth="19"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- Selection indicator bar -->
                                    <Rectangle x:Name="ActiveRectangle"
                                               Grid.Column="0"
                                               Width="3" Height="16"
                                               HorizontalAlignment="Left"
                                               VerticalAlignment="Center"
                                               Fill="#28A745"
                                               RadiusX="2" RadiusY="2"
                                               Visibility="{Binding IsSelected, FallbackValue=Collapsed, Converter={StaticResource BoolToVisibilityConverter}}"/>

                                    <!-- Expander button -->
                                    <ToggleButton x:Name="Expander"
                                                  Grid.Column="0"
                                                  Margin="8,0"
                                                  ClickMode="Press"
                                                  Style="{StaticResource ExpandCollapseToggleButtonStyle}"
                                                  IsChecked="{Binding IsExpanded, RelativeSource={RelativeSource TemplatedParent}}"/>

                                    <!-- Content -->
                                    <ContentPresenter x:Name="PART_Header"
                                                      Grid.Column="1"
                                                      Margin="{TemplateBinding Padding}"
                                                      HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                                      VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                                                      ContentSource="Header"
                                                      TextElement.FontSize="{TemplateBinding FontSize}"/>
                                </Grid>
                            </Border>

                            <!-- Child items container -->
                            <ItemsPresenter x:Name="ItemsHost"
                                            Grid.Row="1"
                                            Margin="19,0,0,0"
                                            Visibility="Collapsed"/>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="HasItems" Value="False">
                                <Setter TargetName="Expander" Property="Visibility" Value="Hidden"/>
                            </Trigger>
                            <Trigger Property="IsExpanded" Value="True">
                                <Setter TargetName="ItemsHost" Property="Visibility" Value="Visible"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Resources>

    <Grid x:Name="RootGrid">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <TextBlock Grid.Row="0"
                   Text="{Binding SelectedRepository.Name, FallbackValue='BRANCHES'}"
                   FontWeight="SemiBold"
                   FontSize="11"
                   Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                   Margin="12,12,12,8"
                   TextTrimming="CharacterEllipsis"/>

        <!-- No repo selected message -->
        <TextBlock Grid.Row="1"
                   Text="Select a repository to view branches"
                   Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Center"
                   Visibility="{Binding SelectedRepository, Converter={StaticResource NullToVisibilityInverseConverter}}"/>

        <!-- Branch tree -->
        <TreeView Grid.Row="1"
                  x:Name="BranchTreeView"
                  ItemsSource="{Binding SelectedRepository.BranchCategories}"
                  BorderThickness="0"
                  Padding="4"
                  Visibility="{Binding SelectedRepository, Converter={StaticResource NullToVisibilityConverter}}">
            <TreeView.Resources>
                <!-- Branch category template (LOCAL/REMOTE/GITFLOW) -->
                <HierarchicalDataTemplate DataType="{x:Type models:BranchCategory}"
                                          ItemsSource="{Binding Converter={StaticResource BranchCategoryItemsConverter}}">
                    <Grid Tag="{Binding DataContext, RelativeSource={RelativeSource AncestorType=UserControl}}">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <StackPanel Grid.Column="0" Orientation="Horizontal" Margin="0,4">
                            <ic:SymbolIcon x:Name="CategoryIcon"
                                           Symbol="BranchFork"
                                           IconVariant="Regular"
                                           FontSize="12"
                                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                           VerticalAlignment="Center"
                                           Margin="0,0,6,0"/>
                            <TextBlock x:Name="CategoryName"
                                       Text="{Binding Name}"
                                       FontSize="11"
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                       VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding BranchCount, StringFormat=' ({0})'}"
                                       FontSize="11"
                                       Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                                       VerticalAlignment="Center"/>
                        </StackPanel>
                        <!-- GitFlow action button -->
                        <Button x:Name="GitFlowActionButton"
                                Grid.Column="1"
                                Visibility="Collapsed"
                                Background="Transparent"
                                BorderThickness="0"
                                Padding="0"
                                Margin="0"
                                Width="{Binding ActualHeight, RelativeSource={RelativeSource Self}}"
                                VerticalAlignment="Stretch"
                                HorizontalContentAlignment="Center"
                                VerticalContentAlignment="Center"
                                Cursor="Hand"
                                Click="GitFlowActionButton_Click"
                                ToolTip="GitFlow actions"
                                Tag="{Binding DataContext, RelativeSource={RelativeSource AncestorType=UserControl}}">
                            <ic:SymbolIcon Symbol="ChevronRight" FontSize="10" Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                            <Button.ContextMenu>
                                <ContextMenu/>
                            </Button.ContextMenu>
                        </Button>
                    </Grid>
                    <HierarchicalDataTemplate.Triggers>
                        <DataTrigger Binding="{Binding IsGitFlowCategory}" Value="True">
                            <Setter TargetName="CategoryIcon" Property="Symbol" Value="Flow"/>
                            <Setter TargetName="CategoryIcon" Property="Foreground" Value="#10B981"/>
                            <Setter TargetName="CategoryName" Property="Foreground" Value="#10B981"/>
                            <Setter TargetName="GitFlowActionButton" Property="Visibility" Value="Visible"/>
                        </DataTrigger>
                    </HierarchicalDataTemplate.Triggers>
                </HierarchicalDataTemplate>

                <!-- Remote branch group template (origin, upstream, etc.) -->
                <HierarchicalDataTemplate DataType="{x:Type models:RemoteBranchGroup}"
                                          ItemsSource="{Binding Branches}">
                    <Border Background="Transparent"
                            Tag="{Binding DataContext, RelativeSource={RelativeSource AncestorType=UserControl}}">
                        <Border.ContextMenu>
                            <ContextMenu>
                                <MenuItem Command="{Binding PlacementTarget.Tag.FetchRemoteCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                          CommandParameter="{Binding Name}">
                                    <MenuItem.Header>
                                        <TextBlock>
                                            <Run Text="Fetch "/><Run Text="{Binding Name, Mode=OneWay}"/>
                                        </TextBlock>
                                    </MenuItem.Header>
                                </MenuItem>
                            </ContextMenu>
                        </Border.ContextMenu>
                        <StackPanel Orientation="Horizontal" Margin="0,2">
                            <!-- GitHub icon -->
                            <Viewbox x:Name="GitHubIcon" Width="11" Height="11" Margin="0,0,6,0"
                                     VerticalAlignment="Center" Visibility="Collapsed">
                                <Path Style="{StaticResource GitHubLogoPath}"/>
                            </Viewbox>
                            <!-- Azure DevOps icon -->
                            <Viewbox x:Name="AzureIcon" Width="11" Height="11" Margin="0,0,6,0"
                                     VerticalAlignment="Center" Visibility="Collapsed">
                                <Path Style="{StaticResource AzureDevOpsLogoPath}"/>
                            </Viewbox>
                            <!-- Cloud icon (fallback) -->
                            <ic:SymbolIcon x:Name="CloudIcon" Symbol="Cloud"
                                           IconVariant="Regular"
                                           FontSize="11"
                                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                           VerticalAlignment="Center"
                                           Margin="0,0,6,0"/>
                            <TextBlock Text="{Binding Name}"
                                       FontSize="11"
                                       Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                                       VerticalAlignment="Center"/>
                        </StackPanel>
                    </Border>
                    <HierarchicalDataTemplate.Triggers>
                        <DataTrigger Binding="{Binding RemoteType}" Value="GitHub">
                            <Setter TargetName="GitHubIcon" Property="Visibility" Value="Visible"/>
                            <Setter TargetName="CloudIcon" Property="Visibility" Value="Collapsed"/>
                        </DataTrigger>
                        <DataTrigger Binding="{Binding RemoteType}" Value="AzureDevOps">
                            <Setter TargetName="AzureIcon" Property="Visibility" Value="Visible"/>
                            <Setter TargetName="CloudIcon" Property="Visibility" Value="Collapsed"/>
                        </DataTrigger>
                    </HierarchicalDataTemplate.Triggers>
                </HierarchicalDataTemplate>

                <!-- Branch template -->
                <DataTemplate DataType="{x:Type models:BranchInfo}">
                    <Border x:Name="BranchBorder"
                            Padding="2,3"
                            Background="Transparent"
                            CornerRadius="2"
                            Cursor="Hand"
                            MouseLeftButtonDown="Branch_MouseLeftButtonDown"
                            MouseRightButtonDown="Branch_MouseRightButtonDown"
                            Tag="{Binding DataContext, RelativeSource={RelativeSource AncestorType=UserControl}}">
                        <Border.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="Checkout"
                                          Command="{Binding PlacementTarget.Tag.CheckoutBranchCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                          CommandParameter="{Binding}"/>
                                <MenuItem Header="Merge into current branch"
                                          Command="{Binding PlacementTarget.Tag.MergeBranchCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                          CommandParameter="{Binding}"
                                          IsEnabled="{Binding IsCurrent, Converter={StaticResource InverseBoolConverter}}"/>
                                <Separator/>
                                <!-- GitFlow Section (branch-specific actions only) -->
                                <MenuItem Header="GitFlow"
                                          Visibility="{Binding GitFlowType, Converter={StaticResource GitFlowTypeToVisibilityConverter}, ConverterParameter=Finishable}">
                                    <MenuItem Header="Finish Branch"
                                              Command="{Binding PlacementTarget.Tag.FinishGitFlowBranchCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                              CommandParameter="{Binding}"/>
                                    <MenuItem Header="Publish Branch"
                                              Command="{Binding PlacementTarget.Tag.PublishGitFlowBranchCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                              CommandParameter="{Binding}"/>
                                </MenuItem>
                                <Separator/>
                                <MenuItem Header="Delete"
                                          Command="{Binding PlacementTarget.Tag.DeleteBranchCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                          CommandParameter="{Binding}"
                                          IsEnabled="{Binding IsCurrent, Converter={StaticResource InverseBoolConverter}}"
                                          Foreground="#DC2626"/>
                            </ContextMenu>
                        </Border.ContextMenu>
                        <StackPanel Orientation="Horizontal">
                            <!-- GitFlow type indicator (colored dot) -->
                            <Border Width="6" Height="6"
                                    CornerRadius="3"
                                    Background="{Binding GitFlowColor}"
                                    Visibility="{Binding GitFlowType, Converter={StaticResource GitFlowTypeToVisibilityConverter}}"
                                    VerticalAlignment="Center"
                                    Margin="0,0,4,0"/>

                            <!-- Branch icon -->
                            <ic:SymbolIcon Symbol="Branch"
                                           IconVariant="Regular"
                                           FontSize="11"
                                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                           VerticalAlignment="Center"
                                           Margin="0,0,6,0"/>

                            <!-- Branch name -->
                            <TextBlock Text="{Binding Name}"
                                       FontSize="11"
                                       Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                                       VerticalAlignment="Center"/>

                            <!-- Current branch indicator -->
                            <ic:SymbolIcon Symbol="Checkmark"
                                           IconVariant="Regular"
                                           FontSize="10"
                                           Foreground="#10B981"
                                           Visibility="{Binding IsCurrent, Converter={StaticResource BoolToVisibilityConverter}}"
                                           VerticalAlignment="Center"
                                           Margin="4,0,0,0"/>
                        </StackPanel>
                    </Border>
                </DataTemplate>
            </TreeView.Resources>

            <TreeView.ItemContainerStyle>
                <!-- Uses custom template with DataContext.IsSelected for multi-select visual -->
                <!-- This allows showing the same branch as selected in both GITFLOW and LOCAL -->
                <Style TargetType="TreeViewItem" BasedOn="{StaticResource MultiSelectBranchTreeViewItemStyle}">
                    <Setter Property="Padding" Value="2"/>
                </Style>
            </TreeView.ItemContainerStyle>
        </TreeView>

        <!-- GitFlow Quick Create Flyout -->
        <Popup x:Name="QuickCreatePopup"
               Placement="Right"
               StaysOpen="False"
               AllowsTransparency="True"
               PopupAnimation="Fade">
            <Border Background="{DynamicResource ApplicationBackgroundBrush}"
                    BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    CornerRadius="6"
                    Padding="12"
                    MinWidth="240">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="16" ShadowDepth="4" Opacity="0.3"/>
                </Border.Effect>
                <StackPanel>
                    <!-- Header -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                        <Border x:Name="QuickCreateTypeIndicator"
                                Width="8" Height="8" CornerRadius="4"
                                VerticalAlignment="Center" Margin="0,0,6,0"/>
                        <TextBlock x:Name="QuickCreateHeader"
                                   Text="Start Feature"
                                   FontSize="12"
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                    </StackPanel>

                    <!-- Name Input -->
                    <TextBox x:Name="QuickCreateNameBox"
                             Padding="8,6"
                             FontSize="12"
                             KeyDown="QuickCreateNameBox_KeyDown"
                             TextChanged="QuickCreateNameBox_TextChanged"/>

                    <!-- Branch Preview -->
                    <TextBlock x:Name="QuickCreatePreview"
                               FontSize="10"
                               FontFamily="Consolas"
                               Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                               TextTrimming="CharacterEllipsis"
                               Margin="2,4,0,0"/>

                    <!-- Suggested Version (for release/hotfix) -->
                    <StackPanel x:Name="QuickCreateVersionPanel"
                                Orientation="Horizontal"
                                Margin="0,6,0,0"
                                Visibility="Collapsed">
                        <TextBlock Text="Suggested:"
                                   FontSize="10"
                                   Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                                   VerticalAlignment="Center"
                                   Margin="0,0,6,0"/>
                        <Button x:Name="QuickCreateVersionButton"
                                Padding="6,2"
                                Click="QuickCreateVersionButton_Click"
                                Background="{DynamicResource ControlFillColorDefaultBrush}">
                            <TextBlock x:Name="QuickCreateVersionText" FontSize="10"/>
                        </Button>
                    </StackPanel>

                    <!-- Buttons -->
                    <StackPanel Orientation="Horizontal"
                                HorizontalAlignment="Right"
                                Margin="0,10,0,0">
                        <Button Content="Cancel"
                                Padding="10,4"
                                FontSize="11"
                                Click="QuickCreateCancel_Click"/>
                        <Button x:Name="QuickCreateStartButton"
                                Content="Start"
                                Margin="6,0,0,0"
                                Padding="12,4"
                                FontSize="11"
                                IsEnabled="False"
                                Click="QuickCreateStart_Click"
                                Background="{DynamicResource AccentFillColorDefaultBrush}"
                                Foreground="White"/>
                    </StackPanel>

                    <!-- Progress -->
                    <StackPanel x:Name="QuickCreateProgress" Visibility="Collapsed" Margin="0,8,0,0">
                        <ProgressBar IsIndeterminate="True" Height="2"/>
                        <TextBlock x:Name="QuickCreateProgressText"
                                   Text="Creating branch..."
                                   FontSize="10"
                                   Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                   Margin="0,4,0,0"/>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Popup>
    </Grid>
</UserControl>
