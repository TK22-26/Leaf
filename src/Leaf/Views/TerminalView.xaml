<UserControl
    x:Class="Leaf.Views.TerminalView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converters="clr-namespace:Leaf.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:ic="clr-namespace:FluentIcons.Wpf;assembly=FluentIcons.Wpf"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    d:DesignHeight="220"
    d:DesignWidth="600"
    mc:Ignorable="d">

    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:InverseBoolConverter x:Key="InverseBoolConverter" />
        <converters:IntGreaterThanZeroToVisibilityConverter x:Key="IntGreaterThanZeroToVisibilityConverter" />

        <Style x:Key="TerminalLineText" TargetType="TextBlock">
            <Setter Property="FontFamily" Value="Cascadia Mono, Consolas" />
            <Setter Property="FontSize" Value="{Binding DataContext.FontSize, RelativeSource={RelativeSource AncestorType=UserControl}}" />
            <Setter Property="Foreground" Value="{DynamicResource TextFillColorPrimaryBrush}" />
            <Setter Property="TextWrapping" Value="Wrap" />
        </Style>

    </UserControl.Resources>

    <Border
        Background="{DynamicResource ControlFillColorTertiaryBrush}"
        BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
        BorderThickness="1,0,1,0">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!--  Output  -->
            <Border
                Grid.Row="0"
                Margin="8,8,8,0"
                Padding="0"
                Background="{DynamicResource ControlFillColorDefaultBrush}"
                BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                BorderThickness="1"
                CornerRadius="4">
                <RichTextBox
                    x:Name="TerminalOutputTextBox"
                    Padding="6,4"
                    Background="Transparent"
                    BorderBrush="Transparent"
                    BorderThickness="0"
                    FontFamily="Cascadia Mono, Consolas"
                    FontSize="{Binding FontSize}"
                    Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                    HorizontalScrollBarVisibility="Disabled"
                    IsDocumentEnabled="True"
                    IsReadOnly="True"
                    Style="{x:Null}"
                    VerticalScrollBarVisibility="Auto" />
            </Border>

            <!--  Input  -->
            <Border
                Grid.Row="1"
                Margin="8"
                Padding="6,4"
                Background="{DynamicResource ControlFillColorDefaultBrush}"
                BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                BorderThickness="1"
                CornerRadius="6">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <Grid
                        Grid.Row="0"
                        Grid.ColumnSpan="3"
                        Margin="2,0,0,4">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <TextBlock
                            Grid.Column="0"
                            VerticalAlignment="Center"
                            FontSize="10"
                            Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                            Text="{Binding WorkingDirectory}"
                            TextTrimming="CharacterEllipsis" />
                    </Grid>
                    <TextBlock
                        Grid.Row="1"
                        Grid.Column="0"
                        Margin="0,0,6,0"
                        VerticalAlignment="Center"
                        FontFamily="Cascadia Mono, Consolas"
                        FontSize="{Binding FontSize}"
                        Foreground="{DynamicResource AccentFillColorDefaultBrush}"
                        Text="{Binding Prompt}" />
                    <TextBox
                        x:Name="TerminalInput"
                        Grid.Row="1"
                        Grid.Column="1"
                        Padding="6,2"
                        VerticalContentAlignment="Center"
                        Background="{DynamicResource ControlFillColorDefaultBrush}"
                        BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        FontFamily="Cascadia Mono, Consolas"
                        FontSize="{Binding FontSize}"
                        Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                        IsEnabled="{Binding IsRunning, Converter={StaticResource InverseBoolConverter}}"
                        KeyDown="TerminalInput_KeyDown"
                        PreviewKeyDown="TerminalInput_PreviewKeyDown"
                        Text="{Binding InputText, UpdateSourceTrigger=PropertyChanged}" />
                    <StackPanel
                        Grid.Row="1"
                        Grid.Column="2"
                        Margin="6,0,0,0"
                        Orientation="Horizontal">
                        <Button
                            Height="28"
                            Margin="0,0,6,0"
                            Padding="6,2"
                            Background="Transparent"
                            BorderThickness="0"
                            Command="{Binding ClearCommand}"
                            ToolTip="Clear output">
                            <StackPanel VerticalAlignment="Center" Orientation="Horizontal">
                                <ic:SymbolIcon
                                    VerticalAlignment="Center"
                                    FontSize="14"
                                    Symbol="Dismiss" />
                                <TextBlock
                                    Margin="4,0,0,2"
                                    VerticalAlignment="Center"
                                    FontSize="11"
                                    Text="Clear" />
                            </StackPanel>
                        </Button>
                        <Button
                            Height="28"
                            Padding="6,2"
                            Background="Transparent"
                            BorderThickness="0"
                            Command="{Binding CancelCommand}"
                            ToolTip="Stop running command"
                            Visibility="{Binding IsRunning, Converter={StaticResource BoolToVisibilityConverter}}">
                            <ic:SymbolIcon
                                FontSize="14"
                                Foreground="Crimson"
                                Symbol="Stop" />
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>
    </Border>
</UserControl>
