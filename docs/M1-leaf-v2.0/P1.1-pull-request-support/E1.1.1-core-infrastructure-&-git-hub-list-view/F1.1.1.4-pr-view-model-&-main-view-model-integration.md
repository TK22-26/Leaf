---
title: PR ViewModel & MainViewModel Integration
status: planned
owner: TBD
start_date: asap
duration: 0.5d
story_points: 3
depends_on: []
follows: []
---

# F1.1.1.4: PR ViewModel & MainViewModel Integration

**Description:**
Create PullRequestViewModel managing PR list state and operations, and integrate with MainViewModel for service injection, event handling, and panel visibility control.

**Technical Approach:**
1. Create PullRequestViewModel.cs with ObservableObject base
2. Add observable properties: RepositoryPath, ProviderType, IsPullRequestSupported, PullRequests collection, FilterStatus, SearchText, SelectedPullRequest, SelectedPrFiles/Commits/Reviews/Comments/Checks collections, IsLoadingList, IsLoadingDetails, StatusMessage, ErrorMessage
3. Add computed property HasSelectedPullRequest
4. Add commands: RefreshCommand, LoadPullRequestDetailsCommand, CheckoutPullRequestCommand, MergePullRequestCommand, ClosePullRequestCommand, UpdatePullRequestCommand, OpenInBrowserCommand, CopyPrUrlCommand
5. Implement ResetActiveLoad() pattern from DiffViewerViewModel for cancellation
6. Add SetRepository() method to initialize when repo changes
7. Add events: OpenFileDiffRequested, GraphRefreshRequested
8. In MainViewModel: add IPullRequestService field, PullRequestViewModel property, IsPullRequestPanelVisible property
9. Add OnPrFileDiffRequested handler to load diff in DiffViewer
10. Add OnPrGraphRefreshRequested handler to refresh GitGraphViewModel (with try/catch)
11. Call PullRequestViewModel.SetRepository() in OnSelectedRepositoryChanged
12. Add TogglePullRequestPanelCommand
- **User Impact:** Responsive PR panel with proper loading states and error feedback
- **Technical Value:** Clean separation between view model and services; follows existing Leaf patterns; proper async/cancellation handling
## Inputs & Outputs

| Name | Type | Nullable | Description |
|:-----|:-----|:---------|:------------|
|  |  |  |  |

**Returns:** void - No return value

| ID | Condition | Expected Behavior |
|:---|:----------|:------------------|
| EC-1 | Repository switched during PR load | Cancel previous load via CancellationToken |
| EC-2 | Checkout fails with Git error | Parse error, display user-friendly message in ErrorMessage |
| EC-3 | PR panel opened for unsupported repo | Show "Pull requests not supported for this repository" |
| EC-4 | Network error during refresh | Show error in StatusMessage, preserve existing list |
| EC-5 | async void event handler throws | Exception caught in try/catch, displayed in StatusMessage (not UI crash) |
| EC-6 | Large PR with 200+ files | Paginate/virtualize file list |
### Functional
- [ ] PullRequestViewModel loads PR list when SetRepository called
- [ ] FilterStatus change triggers list refresh
- [ ] SelectedPullRequest change loads details (files, commits, reviews) via lazy loading
- [ ] CheckoutPullRequestCommand executes checkout and raises GraphRefreshRequested
- [ ] OpenInBrowserCommand opens PR URL in default browser
- [ ] MainViewModel.IsPullRequestPanelVisible toggles panel display
- [ ] Repository change cancels in-flight loads

### Quality
- [ ] CancellationToken used for all async operations
- [ ] async void handlers wrapped in try/catch
- [ ] Loading states (IsLoadingList, IsLoadingDetails) properly set
- [ ] ErrorMessage cleared on successful operations
- [ ] Follows DiffViewerViewModel patterns
## Dependencies

| Type | ID/Name | Notes |
|:-----|:--------|:------|
| Depends On | None | |
| Blocks | None | |

### US-1: PR Panel State Management

**User Story:**
> As a user, I want clear feedback when PR operations are in progress or encounter errors.

**Acceptance Criteria:**
1. Given I click Refresh, when loading, then IsLoadingList is true and list shows loading indicator
2. Given checkout fails, when error occurs, then ErrorMessage displays the reason clearly
3. Given I switch repositories, when new repo has PRs, then list updates without showing stale data
4. Given I select a PR, when details load, then files/commits/reviews load lazily (not all at once)
## Amendments

| Date | Category | Description | Rationale |
|:-----|:---------|:------------|:----------|

## Proposed Improvements

<!-- Document opportunities for refactoring, scope adjustments, or better engineering practices here. Do not implement yet; just log them. When a proposed improvement affects work above this item's level, document it in the appropriate ancestor. -->

| ID | Description | Resolution |
|:---|:------------|:-----------|
