---
title: GitHub PR Service Implementation
status: planned
owner: TBD
start_date: asap
duration: 1.5d
story_points: 8
depends_on: []
follows: []
---

# F1.1.1.3: GitHub PR Service Implementation

**Description:**
Implement GitHubPullRequestService with full GitHub REST API integration for listing, viewing, creating, and managing pull requests. Handle pagination, authentication, rate limiting, and fork-aware checkout.

**Technical Approach:**
1. Create GitHubPullRequestService.cs with HttpClient injection (singleton/IHttpClientFactory pattern)
2. Implement GetToken() following GitHubService.cs pattern (OAuth first, then PAT)
3. Implement ParseRemoteUrl() to extract owner/repo from HTTPS and SSH URLs
4. Implement FetchAllPagesAsync() helper following Link header for pagination
5. Implement ListPullRequestsAsync using GET /repos/{owner}/{repo}/pulls with state filter
6. Implement GetPullRequestAsync using GET /repos/{owner}/{repo}/pulls/{number}
7. Implement GetPullRequestFilesAsync using GET /repos/{owner}/{repo}/pulls/{number}/files
8. Implement GetPullRequestCommitsAsync using GET /repos/{owner}/{repo}/pulls/{number}/commits
9. Implement GetPullRequestReviewsAsync using GET /repos/{owner}/{repo}/pulls/{number}/reviews
10. Implement GetPullRequestCommentsAsync combining review comments and issue comments
11. Implement CheckoutPullRequestAsync with fork detection, dirty working directory check, and branch collision handling
12. Add Accept: application/vnd.github+json header to all requests
13. Handle 403/rate limit responses with user-friendly messages
- **User Impact:** View GitHub PRs directly in Leaf; checkout PRs locally for review including fork PRs
- **Technical Value:** Complete GitHub API coverage; proper HTTP client lifecycle; handles all edge cases
## Inputs & Outputs

| Name | Type | Nullable | Description |
|:-----|:-----|:---------|:------------|
|  |  |  |  |

**Returns:** void - No return value

| ID | Condition | Expected Behavior |
|:---|:----------|:------------------|
| EC-1 | PR from fork | Detect head repo URL, add temp remote, fetch, cleanup |
| EC-2 | Local branch pr-{number} already exists | Check tracking ref; if same PR, checkout and pull; if different, use pr-{number}-leaf |
| EC-3 | Dirty working directory | Pre-flight check, throw InvalidOperationException with clear message |
| EC-4 | Rate limit exceeded | Parse X-RateLimit-Remaining header, throw descriptive HttpRequestException |
| EC-5 | Missing auth token | Throw InvalidOperationException prompting user to add PAT |
| EC-6 | PR with 100+ files | Paginate file list (per_page=100, follow Link header) |
| EC-7 | Comments from both review and issue endpoints | Aggregate and sort by date |
| EC-8 | Find PRs missing preview header | Returns 415 or empty - include groot-preview header |
### Functional
- [ ] ListPullRequestsAsync returns all PRs with pagination (Link header followed)
- [ ] GetPullRequestAsync maps HeadSha from head.sha, BaseSha from base.sha
- [ ] GetPullRequestFilesAsync returns files with Patch when available
- [ ] GetPullRequestCommentsAsync combines review comments and issue comments
- [ ] GetPullRequestChecksAsync uses HeadSha (no extra API call needed)
- [ ] CheckoutPullRequestAsync creates local branch pr-{number} tracking PR head
- [ ] CheckoutPullRequestAsync handles fork PRs by adding/removing temp remote
- [ ] CheckoutPullRequestAsync detects and reports dirty working directory
- [ ] UpdatePullRequestAsync uses separate endpoints for draft toggle
- [ ] FindPullRequestsForCommitAsync includes groot-preview header

### Quality
- [ ] HttpClient injected, not created per-request
- [ ] UserAgent header set to "Leaf/1.0"
- [ ] Accept header set to "application/vnd.github+json"
- [ ] All async methods accept CancellationToken
- [ ] Follow GitHubService.cs patterns for auth and error handling
## Dependencies

| Type | ID/Name | Notes |
|:-----|:--------|:------|
| Depends On | None | |
| Blocks | None | |

### US-1: List GitHub PRs

**User Story:**
> As a developer with a GitHub repository, I want to see all open pull requests so that I can review them without opening a browser.

**Acceptance Criteria:**
1. Given a GitHub repo with open PRs, when I open the PR panel, then all open PRs display with number, title, author, and date
2. Given I filter to "Closed", when the list updates, then only closed and merged PRs display
3. Given a repo with 150+ PRs, when I list them, then pagination fetches all pages

### US-2: Checkout PR Branch

**User Story:**
> As a reviewer, I want to checkout a PR branch locally so that I can test changes before approving.

**Acceptance Criteria:**
1. Given an open PR, when I click Checkout, then local branch pr-{number} is created and checked out
2. Given uncommitted changes, when I click Checkout, then I see "Please stash or commit changes first"
3. Given a fork PR, when I click Checkout, then the fork remote is added temporarily, PR is checked out, and temp remote is removed
## Amendments

| Date | Category | Description | Rationale |
|:-----|:---------|:------------|:----------|

## Proposed Improvements

<!-- Document opportunities for refactoring, scope adjustments, or better engineering practices here. Do not implement yet; just log them. When a proposed improvement affects work above this item's level, document it in the appropriate ancestor. -->

| ID | Description | Resolution |
|:---|:------------|:-----------|
