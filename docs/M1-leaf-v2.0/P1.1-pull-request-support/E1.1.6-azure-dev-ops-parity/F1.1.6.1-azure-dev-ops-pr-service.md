---
title: Azure DevOps PR Service
status: planned
owner: TBD
start_date: asap
duration: 1.5d
story_points: 8
depends_on: []
follows: []
---

# F1.1.6.1: Azure DevOps PR Service

**Description:**
Implement AzureDevOpsPullRequestService with full Azure DevOps REST API integration matching GitHub feature set.

**Technical Approach:**

1. **HttpClient Lifecycle:**
   - Inject HttpClient via DI (IHttpClientFactory or singleton)
   - **CRITICAL:** Do NOT create HttpClient per-request to avoid socket exhaustion
   - Follow same pattern as GitHubPullRequestService

2. **Authentication:**
   - Basic auth: empty username, PAT as password
   - `_credentialService.GetCredential("AzureDevOps")`

3. **Base URL:** `https://dev.azure.com/{org}/{project}/_apis/git/repositories/{repo}`
   - API version: `api-version=7.0`

4. **URL Parsing** (ParseRemoteUrl):
   - `https://dev.azure.com/{org}/{project}/_git/{repo}`
   - `https://{org}.visualstudio.com/{project}/_git/{repo}`
   - `{org}@vs-ssh.visualstudio.com:v3/{org}/{project}/{repo}`

5. **API Endpoints:**
   ```
   GET  /pullrequests                           - List PRs
   GET  /pullrequests/{id}                      - Get PR details
   GET  /pullrequests/{id}/commits              - Get commits
   GET  /pullrequests/{id}/iterations           - Get iterations (for files)
   GET  /pullrequests/{id}/threads              - Get comments
   GET  /pullrequests/{id}/statuses             - Get status checks
   POST /pullrequests                           - Create PR
   PATCH /pullrequests/{id}                     - Update/merge/close
   ```

6. **Field Mapping:**
   - HeadSha: `lastMergeSourceCommit.commitId`
   - BaseSha: `lastMergeTargetCommit.commitId`
   - Reviewers: Parse from PR response `reviewers` array

7. **Merge:** PATCH with `status: "completed"` and `completionOptions`
8. **Close:** PATCH with `status: "abandoned"`
## Business Value

- **User Impact:** Full PR support for Azure DevOps repositories; same UX as GitHub
- **Technical Value:** Implements IPullRequestService; abstracts Azure REST API differences

## Inputs & Outputs

| Name | Type | Nullable | Description |
|:-----|:-----|:---------|:------------|
|  |  |  |  |

**Returns:** void - No return value

## Edge Cases & Boundary Conditions

| ID | Condition | Expected Behavior |
|:---|:----------|:------------------|
| EC-1 | Old visualstudio.com URL format | Parse correctly (legacy org.visualstudio.com format) |
| EC-2 | SSH URL format | Parse v3/{org}/{project}/{repo} correctly |
| EC-3 | No PAT configured | Throw InvalidOperationException with setup instructions |
| EC-4 | PR with auto-complete | Map completionOptions correctly |
| EC-5 | Different API versions | Use api-version=7.0 consistently |

## Acceptance Criteria

### Functional
- [ ] All IPullRequestService methods implemented
- [ ] URL parsing handles all Azure DevOps formats (dev.azure.com, visualstudio.com, SSH)
- [ ] Basic auth with PAT works correctly
- [ ] HeadSha maps from lastMergeSourceCommit.commitId
- [ ] BaseSha maps from lastMergeTargetCommit.commitId
- [ ] Merge uses PATCH with status:completed
- [ ] Close uses PATCH with status:abandoned
- [ ] api-version=7.0 included in all requests

### Quality
- [ ] HttpClient injected via DI (not created per-request) to avoid socket exhaustion
- [ ] Error messages match Azure DevOps API responses
- [ ] No compiler warnings

## Dependencies

| Type | ID/Name | Notes |
|:-----|:--------|:------|
| Depends On | None | |
| Blocks | None | |

## User Stories

### US-1: List Azure DevOps PRs

**User Story:**
> As a developer using Azure DevOps, I want to see PRs in Leaf so that I have the same experience as GitHub users.

**Acceptance Criteria:**
1. Given an Azure DevOps repo, when I open PR panel, then all open PRs display
2. Given I select a PR, when details load, then HeadSha/BaseSha are correct
3. Given I filter by state, when list updates, then filter works correctly

### US-2: Manage Azure DevOps PRs

**User Story:**
> As a developer, I want to create, merge, and close PRs on Azure DevOps from Leaf.

**Acceptance Criteria:**
1. Given I create a PR, when POST succeeds, then PR appears in list
2. Given I merge a PR, when PATCH with status:completed succeeds, then PR shows as merged
3. Given I close a PR, when PATCH with status:abandoned succeeds, then PR shows as closed

## Amendments

| Date | Category | Description | Rationale |
|:-----|:---------|:------------|:----------|

## Proposed Improvements

<!-- Document opportunities for refactoring, scope adjustments, or better engineering practices here. Do not implement yet; just log them. When a proposed improvement affects work above this item's level, document it in the appropriate ancestor. -->

| ID | Description | Resolution |
|:---|:------------|:-----------|
