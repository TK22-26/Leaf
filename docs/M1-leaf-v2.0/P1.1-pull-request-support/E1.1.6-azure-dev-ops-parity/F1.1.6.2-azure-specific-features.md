---
title: Azure-specific Features
status: planned
owner: TBD
start_date: asap
duration: 1d
story_points: 5
depends_on: []
follows: []
---

# F1.1.6.2: Azure-specific Features

**Description:**
Handle Azure DevOps-specific patterns: comment threads with resolution, iterations API for file diffs, and reviewer vote-to-state mapping.

**Technical Approach:**

1. **Vote Mapping:**
   ```csharp
   private static PullRequestReviewState MapAzureDevOpsVote(int vote) => vote switch
   {
       10 => PullRequestReviewState.Approved,
       5 => PullRequestReviewState.ApprovedWithSuggestions,
       0 => PullRequestReviewState.Pending,           // No vote
       -5 => PullRequestReviewState.WaitingForAuthor,
       -10 => PullRequestReviewState.ChangesRequested, // Rejected
       _ => PullRequestReviewState.Pending            // Unknown
   };
   ```

2. **Thread Handling:**
   - GET /pullrequests/{id}/threads
   - Each thread has `comments` array and `status` (active, fixed, closed)
   - Map thread.status to IsResolved
   - Set FilePath/LineNumber from threadContext

3. **Iterations API for File Diffs:**
   ```csharp
   // Get latest iteration
   var iterations = await GetIterationsAsync(prId);
   var latest = iterations.Last();

   // Use iteration commits for accurate diff base
   var sourceCommit = latest.sourceRefCommit.commitId;
   var baseCommit = latest.commonRefCommit.commitId;

   // Fetch file contents at specific commits
   var baseContent = await GetFileAtCommit(filePath, baseCommit);
   var headContent = await GetFileAtCommit(filePath, sourceCommit);
   return _diffService.ComputeDiff(baseContent, headContent, ...);
   ```

4. **FindPullRequestsForCommit:**
   - Search PRs where lastMergeSourceCommit.commitId matches SHA
   - Or iterate PR commits list
## Business Value

- **User Impact:** Thread resolution, vote states, and iterations work correctly for Azure DevOps
- **Technical Value:** Proper vote-to-state mapping; iterations API for accurate file diffs

## Inputs & Outputs

| Name | Type | Nullable | Description |
|:-----|:-----|:---------|:------------|
|  |  |  |  |

**Returns:** void - No return value

## Edge Cases & Boundary Conditions

| ID | Condition | Expected Behavior |
|:---|:----------|:------------------|
| EC-1 | Vote value outside known range | Map to Pending (safe default) |
| EC-2 | Thread with no comments | Skip thread in display |
| EC-3 | Resolved thread | Show with IsResolved=true, visually de-emphasized |
| EC-4 | Iteration with merge conflicts | Use latest iteration's commits for accurate diff |
| EC-5 | Comment without threadContext | Display as general PR comment |

## Acceptance Criteria

### Functional
- [ ] Vote mapping: 10=Approved, 5=ApprovedWithSuggestions, 0=Pending, -5=WaitingForAuthor, -10=ChangesRequested
- [ ] Thread comments parsed from GET /pullrequests/{id}/threads
- [ ] Thread status mapped to IsResolved (active/fixed/closed)
- [ ] File/line context from threadContext property
- [ ] Iterations API used for file diffs (sourceRefCommit, commonRefCommit)
- [ ] FindPullRequestsForCommit searches lastMergeSourceCommit.commitId

### Quality
- [ ] Unknown vote values safely default to Pending
- [ ] No compiler warnings

## Dependencies

| Type | ID/Name | Notes |
|:-----|:--------|:------|
| Depends On | None | |
| Blocks | None | |

## User Stories

### US-1: View Azure DevOps Reviews

**User Story:**
> As a developer using Azure DevOps, I want to see reviewer votes with proper states so that I understand approval status.

**Acceptance Criteria:**
1. Given a vote of 10, when displayed, then state shows as "Approved" (green)
2. Given a vote of -10, when displayed, then state shows as "ChangesRequested" (red)
3. Given a vote of -5, when displayed, then state shows as "WaitingForAuthor" (orange)

### US-2: View Azure DevOps Comments

**User Story:**
> As a developer, I want to see threaded comments with resolution status so that I can follow discussions.

**Acceptance Criteria:**
1. Given a resolved thread, when displayed, then IsResolved indicator shows
2. Given a file-specific comment, when displayed, then file path and line number show
3. Given multiple threads, when displayed, then each thread groups its comments

## Amendments

| Date | Category | Description | Rationale |
|:-----|:---------|:------------|:----------|

## Proposed Improvements

<!-- Document opportunities for refactoring, scope adjustments, or better engineering practices here. Do not implement yet; just log them. When a proposed improvement affects work above this item's level, document it in the appropriate ancestor. -->

| ID | Description | Resolution |
|:---|:------------|:-----------|
