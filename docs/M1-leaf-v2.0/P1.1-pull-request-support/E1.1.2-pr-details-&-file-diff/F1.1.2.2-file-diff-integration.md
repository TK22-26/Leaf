---
title: File Diff Integration
status: planned
owner: TBD
start_date: asap
duration: 1d
story_points: 5
depends_on: []
follows: []
---

# F1.1.2.2: File Diff Integration

**Description:**
Implement GetPullRequestFileDiffAsync to parse unified diff patches from GitHub API, and connect file list clicks to existing DiffViewer for displaying PR file changes with accurate line numbers.

**Technical Approach:**

1. **ParseUnifiedDiff Method:**
   ```csharp
   public FileDiffResult ParseUnifiedDiff(string patch, string fileName, string filePath)
   {
       var lines = new List<DiffLine>();
       int oldLineNum = 0, newLineNum = 0;

       foreach (var line in patch.Split('\n'))
       {
           if (line.StartsWith("@@"))
           {
               // Parse hunk header: @@ -oldStart,count +newStart,count @@
               var hunkInfo = ParseHunkHeader(line);
               oldLineNum = hunkInfo.oldStart;
               newLineNum = hunkInfo.newStart;

               lines.Add(new DiffLine {
                   Type = DiffLineType.Hunk,
                   Content = line,
                   HunkOldStart = hunkInfo.oldStart,
                   HunkNewStart = hunkInfo.newStart
               });
               continue;
           }

           var prefix = line.Length > 0 ? line[0] : ' ';
           var content = line.Length > 1 ? line[1..] : string.Empty;

           lines.Add(prefix switch {
               '+' => new DiffLine { Type = DiffLineType.Added, Content = content,
                   OldLineNumber = null, NewLineNumber = newLineNum++ },
               '-' => new DiffLine { Type = DiffLineType.Deleted, Content = content,
                   OldLineNumber = oldLineNum++, NewLineNumber = null },
               '\\' => new DiffLine { Type = DiffLineType.Meta, Content = content },
               _ => new DiffLine { Type = DiffLineType.Unchanged, Content = content,
                   OldLineNumber = oldLineNum++, NewLineNumber = newLineNum++ }
           });
       }
       return new FileDiffResult { FileName = fileName, FilePath = filePath, Lines = lines, ... };
   }
   ```

2. **ParseHunkHeader:**
   ```csharp
   // Regex: @@ -(\d+)(?:,(\d+))? \+(\d+)(?:,(\d+))? @@
   private static (int oldStart, int oldCount, int newStart, int newCount)? ParseHunkHeader(string line)
   ```

3. **DiffLine Model Extensions:**
   ```csharp
   public class DiffLine {
       public DiffLineType Type { get; set; }
       public string Content { get; set; }
       public int? OldLineNumber { get; set; }  // null for additions/hunks
       public int? NewLineNumber { get; set; }  // null for deletions/hunks
       public int? HunkOldStart { get; set; }   // Only for Type == Hunk
       public int? HunkNewStart { get; set; }   // Only for Type == Hunk
   }

   public enum DiffLineType {
       Unchanged, Added, Deleted, Modified, Imaginary,
       Hunk,  // NEW: Hunk header line
       Meta   // NEW: "No newline at end of file"
   }
   ```

4. **GetPullRequestFileDiffAsync:**
   ```csharp
   public async Task<FileDiffResult?> GetPullRequestFileDiffAsync(...)
   {
       // If patch available (GitHub), use ParseUnifiedDiff
       var fileInfo = await GetFileInfoAsync(...);
       if (!string.IsNullOrEmpty(fileInfo?.Patch))
           return ParseUnifiedDiff(fileInfo.Patch, fileInfo.FileName, filePath);

       // Otherwise (Azure DevOps or large files), fetch contents and use DiffService
       var baseContent = await FetchFileContentAsync(..., isBase: true);
       var headContent = await FetchFileContentAsync(..., isBase: false);
       return _diffService.ComputeDiff(baseContent, headContent, fileName, filePath);
   }
   ```

5. **Wire to DiffViewer:**
   ```csharp
   // In MainViewModel.OnPrFileDiffRequested:
   var diffResult = await _pullRequestService.GetPullRequestFileDiffAsync(
       SelectedRepository.Path, prNumber, file.Path);
   DiffViewerViewModel.LoadDiff(diffResult);
   IsDiffViewerVisible = true;
   ```
## Business Value

- **User Impact:** Users can click any file in PR list to view the unified diff, enabling code review directly in Leaf
- **Technical Value:** Leverages existing DiffView infrastructure; handles large files and binary files gracefully; reuses patch data to minimize API calls

## Inputs & Outputs

| Name | Type | Nullable | Description |
|:-----|:-----|:---------|:------------|
|  |  |  |  |

**Returns:** void - No return value

## Edge Cases & Boundary Conditions

| ID | Condition | Expected Behavior |
|:---|:----------|:------------------|
| EC-1 | Binary file in PR | Show "Binary file changed" message, IsDiffUnavailable=true |
| EC-2 | Large file (>1MB) without patch | Fetch content via raw file API, compute diff locally |
| EC-3 | File renamed with changes | Show both old path and new path, diff shows content changes |
| EC-4 | Hunk header with extra context | Regex handles optional @@ -1,5 +1,6 @@ function name() pattern |
| EC-5 | "No newline at end of file" marker | Parsed as Meta line type, displayed appropriately |

### Functional
- [ ] ParseUnifiedDiff correctly parses +/- lines with accurate line numbers
- [ ] Hunk headers (@@ ... @@) displayed as separator lines
- [ ] Line numbers enable navigation/blame integration
- [ ] Clicking file in list opens diff in DiffViewer
- [ ] Binary files show "Binary file" message
- [ ] Large files without patch fall back to content-based diff
- [ ] "No newline at end of file" parsed as Meta line type

### Quality
- [ ] Regex for hunk header handles optional context text after @@
- [ ] DiffViewer receives correct FileDiffResult format
- [ ] No extra API calls when patch is available
## Dependencies

| Type | ID/Name | Notes |
|:-----|:--------|:------|
| Depends On | None | |
| Blocks | None | |

## User Stories

### US-1: View File Diff in PR

**User Story:**
> As a code reviewer, I want to click a file in the PR list and see the diff so that I can review changes line by line.

**Acceptance Criteria:**
1. Given I click a file in the PR file list, when DiffView opens, then I see the unified diff with proper syntax highlighting
2. Given a binary file in the PR, when I click it, then I see "Binary file changed" message instead of diff
3. Given a renamed file, when I view the diff, then both old and new paths display in header
4. Given a large file (>1MB), when patch is unavailable, then content is fetched via API and diff computed locally

## Amendments

| Date | Category | Description | Rationale |
|:-----|:---------|:------------|:----------|

## Proposed Improvements

<!-- Document opportunities for refactoring, scope adjustments, or better engineering practices here. Do not implement yet; just log them. When a proposed improvement affects work above this item's level, document it in the appropriate ancestor. -->

| ID | Description | Resolution |
|:---|:------------|:-----------|
